# =============================================================================
# Zig Matching Engine - Docker Compose
# =============================================================================
#
# Usage:
#   docker compose up -d          # Start
#   docker compose logs -f        # View logs
#   docker compose down           # Stop
#
# Modes:
#   docker compose up -d                    # Single-threaded
#   ENGINE_THREADED=true docker compose up  # Dual-processor
#
# =============================================================================

services:
  matching-engine:
    build:
      context: .
      dockerfile: Dockerfile
    image: zig-matching-engine:latest
    container_name: matching-engine
    
    # Port mappings (host:container)
    ports:
      - "1234:1234"      # TCP
      - "1235:1235/udp"  # UDP
      - "1236:1236/udp"  # Multicast (if needed)
    
    # Environment configuration
    environment:
      - ENGINE_TCP_ENABLED=true
      - ENGINE_TCP_PORT=1234
      - ENGINE_UDP_ENABLED=true
      - ENGINE_UDP_PORT=1235
      - ENGINE_MCAST_ENABLED=true
      - ENGINE_MCAST_GROUP=239.255.0.1
      - ENGINE_MCAST_PORT=1236
      - ENGINE_THREADED=${ENGINE_THREADED:-false}
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M
    
    # Health check
    healthcheck:
      test: ["CMD", "sh", "-c", "timeout 1 sh -c 'echo > /dev/tcp/localhost/9000' 2>/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    # Network
    networks:
      - trading-net

  # Optional: Prometheus metrics exporter (placeholder for future)
  # metrics:
  #   image: prom/prometheus:latest
  #   ports:
  #     - "9090:9090"
  #   networks:
  #     - trading-net

networks:
  trading-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Usage Examples
# =============================================================================
#
# Basic start:
#   docker compose up -d
#
# Threaded mode:
#   ENGINE_THREADED=true docker compose up -d
#
# Custom ports:
#   ENGINE_TCP_PORT=8000 ENGINE_UDP_PORT=8001 docker compose up -d
#
# View logs:
#   docker compose logs -f matching-engine
#
# Stop:
#   docker compose down
#
# Rebuild after code changes:
#   docker compose build --no-cache
#   docker compose up -d
#
# =============================================================================
